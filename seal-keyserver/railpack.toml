# Railpack configuration for SEAL Key Server
# Railway will use this to build the Rust project

[phases.setup]
nixPkgs = ["rustc", "cargo", "openssl", "pkg-config", "libpq", "python3", "socat", "curl"]

[phases.build]
cmds = [
  "cd seal && cargo build --bin seal-cli --release --config net.git-fetch-with-cli=true",
  "cd seal && cargo build --bin key-server --release --config net.git-fetch-with-cli=true"
]
cacheDirectories = ["seal/target"]

[phases.install]
cmds = [
  "mkdir -p /opt/key-server/bin",
  "cp seal/target/release/key-server /opt/key-server/bin/key-server",
  "cp seal/target/release/seal-cli /opt/key-server/bin/seal-cli",
  "chmod +x /opt/key-server/bin/key-server /opt/key-server/bin/seal-cli",
  "test -f /opt/key-server/bin/key-server && test -f /opt/key-server/bin/seal-cli && echo '✅ Binaries installed successfully' || (echo '❌ Binary installation failed' && exit 1)"
]

[start]
cmd = "./start.sh"

