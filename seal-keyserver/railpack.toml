# Railpack configuration for SEAL Key Server
# Railway will use this to build the Rust project

[phases.setup]
nixPkgs = ["rustc", "cargo", "openssl", "pkg-config", "libpq", "python3", "socat", "curl"]

[phases.build]
cmds = [
  "chmod +x build.sh",
  "bash build.sh"
]
cacheDirectories = ["seal/target"]

[phases.install]
cmds = [
  "mkdir -p /opt/key-server/bin",
  "test -f seal/target/release/key-server || (echo '❌ key-server binary not found after build' && exit 1)",
  "test -f seal/target/release/seal-cli || (echo '❌ seal-cli binary not found after build' && exit 1)",
  "cp seal/target/release/key-server /opt/key-server/bin/key-server",
  "cp seal/target/release/seal-cli /opt/key-server/bin/seal-cli",
  "chmod +x /opt/key-server/bin/key-server /opt/key-server/bin/seal-cli",
  "test -f /opt/key-server/bin/key-server && test -f /opt/key-server/bin/seal-cli && echo '✅ Binaries installed successfully' || (echo '❌ Binary installation failed' && exit 1)"
]

[start]
cmd = "./start.sh"

