// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Dataset {
  id                      String   @id
  creator                 String
  quality_score           Int
  price                   BigInt
  listed                  Boolean  @default(true)
  duration_seconds        Int      // Deprecated: use total_duration for multi-file
  languages               String[]
  formats                 String[]
  media_type              String
  created_at              DateTime @default(now())
  title                   String
  description             String
  total_purchases         Int      @default(0)
  seal_policy_id          String?

  // Multi-file dataset support
  file_count              Int      @default(1)
  total_duration          Int?     // Sum of all file durations
  bundle_discount_bps     Int?     // Basis points (2000 = 20% discount)

  // Relations
  blobs                   DatasetBlob[]  // Changed from 1:1 to 1:many
  purchases               Purchase[]
  access_logs             AccessLog[]

  @@index([creator])
  @@index([created_at])
}

model DatasetBlob {
  id               String   @id @default(uuid())
  dataset_id       String
  file_index       Int      // Order within dataset (0, 1, 2, ...)
  preview_blob_id  String
  full_blob_id     String
  duration_seconds Int
  seal_policy_id   String?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  // Relations
  dataset          Dataset  @relation(fields: [dataset_id], references: [id], onDelete: Cascade)

  @@unique([dataset_id, file_index])
  @@index([dataset_id])
}

model Purchase {
  id               String   @id @default(uuid())
  user_address     String
  dataset_id       String
  price            BigInt
  tx_digest        String   @unique
  timestamp        DateTime @default(now())

  // Multi-file purchase support
  purchase_type    String   @default("bundle")  // "bundle" | "individual"
  file_indices     Int[]    @default([])        // [0,2,4] if buying specific files

  // Relations
  dataset          Dataset  @relation(fields: [dataset_id], references: [id], onDelete: Cascade)

  @@index([user_address])
  @@index([dataset_id])
  @@index([timestamp])
}

model AccessLog {
  id               String   @id @default(uuid())
  user_address     String
  dataset_id       String
  action           String   // ACCESS_GRANTED, STREAM_STARTED, DOWNLOAD_COMPLETED, ACCESS_DENIED
  ip_address       String?
  user_agent       String?
  timestamp        DateTime @default(now())

  // Relations
  dataset          Dataset  @relation(fields: [dataset_id], references: [id], onDelete: Cascade)

  @@index([user_address])
  @@index([dataset_id])
  @@index([timestamp])
}
