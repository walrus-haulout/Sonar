# SONAR Backend

Decentralized Audio Data Marketplace - Backend Service

## Setup

### 1. Prerequisites

- Bun (https://bun.sh/)
- PostgreSQL 14+ (local or Railway)
- Node.js 18+ (for package managers)

### 2. Installation

```bash
# From root directory
bun install

# Generate JWT secret and create .env
cd backend
bun run setup
```

### 3. Configure Database

Edit `backend/.env` and set `DATABASE_URL`:

**Local PostgreSQL:**
```bash
DATABASE_URL="postgresql://postgres:password@localhost:5432/sonar_dev"
```

**Railway Postgres:**
```bash
# Create database on Railway, copy connection string
DATABASE_URL="postgresql://user:pass@host:5432/db"
```

### 4. Initialize Database

```bash
# Run migrations
bun run db:migrate

# Seed with sample datasets
bun run db:seed
```

### 5. Development

```bash
# Start dev server with hot reload
bun run dev

# In another terminal, from frontend:
cd ../frontend
bun run dev
```

Server runs at `http://localhost:3001`

## Environment Variables

See `backend/.env.example` for all available options:

- `DATABASE_URL` - PostgreSQL connection string
- `JWT_SECRET` - Generated by setup script
- `SUI_RPC_URL` - Sui testnet RPC
- `SONAR_PACKAGE_ID` - Deployed contract package ID
- `WALRUS_AGGREGATOR_URL` - Walrus testnet endpoint
- `LOG_LEVEL` - Logging level (info, debug, error)

## API Endpoints

### Authentication
- `POST /auth/challenge` - Request challenge for signing
- `POST /auth/verify` - Verify signed message and get JWT

### Access Control
- `POST /api/datasets/:id/access` - Get access grant (requires JWT)

### Streaming
- `GET /api/datasets/:id/preview` - Stream preview audio (public)
- `GET /api/datasets/:id/stream` - Stream full audio (requires purchase)

### Health
- `GET /health` - Health check

## Authentication Flow

1. **Request Challenge**
   ```
   POST /auth/challenge
   Body: { address: "0x..." }
   ```

2. **Sign Message with Wallet**
   - Use wallet to sign the returned message

3. **Verify Signature**
   ```
   POST /auth/verify
   Body: { address, signature, nonce }
   Response: { token, expiresAt }
   ```

4. **Use Token**
   ```
   Authorization: Bearer {token}
   ```

## Database Schema

### Dataset
- Metadata from blockchain
- Quality score, duration, languages, formats

### DatasetBlob
- Maps dataset_id â†’ blob metadata
- Persists Walrus `full_blob_id` + `preview_blob_id`
- Stores original `mime_type` and `preview_mime_type` for accurate streaming headers
- **NEVER stores blob_ids on-chain for privacy**

### Purchase
- User address, dataset_id, transaction digest
- Tracks purchase history

### AccessLog
- Audit trail for all file access
- Action, IP, user agent, timestamp

## Logging

Logs include trace IDs for request tracking:
- Development: Pretty-printed to console
- Production: JSON format for log aggregation

Example:
```json
{
  "level": 20,
  "time": "2024-01-01T12:00:00.000Z",
  "traceId": "550e8400-e29b-41d4-a716-446655440000",
  "path": "/api/datasets/0xdemo1/access",
  "method": "POST",
  "msg": "Access granted"
}
```

## Deployment

### Railway

1. Create Railway project
2. Provision PostgreSQL database
3. Add backend service:
   - Build: Dockerfile
   - Start: `bun dist/index.js`
   - PORT: 3001

4. Set environment variables in dashboard

5. Deploy via Git push

See `Dockerfile` and `railway.json`

## Testing

### Unit Tests
```bash
bun test
```

### Manual Testing
```bash
# Health check
curl http://localhost:3001/health

# Request challenge
curl -X POST http://localhost:3001/auth/challenge \
  -H "Content-Type: application/json" \
  -d '{"address":"0x..."}'
```

## Troubleshooting

### Database Connection Failed
- Check `DATABASE_URL` format
- Verify database exists
- Check network/firewall

### JWT_SECRET not found
```bash
bun run setup
```

### Prisma Migrations Issue
```bash
# Reset database (warning: deletes data)
bun run db:reset
```

## Future Enhancements

- [ ] Walrus integration (live blob fetching)
- [ ] Seal decryption
- [ ] Rate limiting tuning
- [ ] Sentry error tracking
- [ ] Admin dashboard

## Support

For issues and questions, check:
- `docs/WALRUS_INTEGRATION.md`
- `backend/prisma/schema.prisma`
- Environment variable documentation

---

Generated with [Claude Code](https://claude.com/claude-code)
